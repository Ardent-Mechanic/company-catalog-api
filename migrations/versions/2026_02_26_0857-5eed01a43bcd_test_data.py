"""test data

Revision ID: 5eed01a43bcd
Revises: 777793a24231
Create Date: 2026-02-26 08:57:02.855633
Confirmed by:
"""

from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa
import geoalchemy2
import logging

# revision identifiers
revision: str = "5eed01a43bcd"
down_revision: Union[str, Sequence[str], None] = "777793a24231"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None

logger = logging.getLogger("alembic.runtime.migration")


def upgrade() -> None:
    logger.info(
        f"=== APPLYING MIGRATION === | "
        f"Revision: {revision} | "
        f"Down: {down_revision} | "
        f"Message: nullable lat and lon"
    )
    
    conn = op.get_bind()

    # ─── 1. Деятельности (дерево до 3 уровня) ─────────────────────────────────
    activity_parents = {
        "Еда и напитки": None,
        "Медицина и здоровье": None,
        "Авто и транспорт": None,
        "Красота и уход": None,
        "Образование": None,
        "Дом и ремонт": None,
        "IT и связь": None,
    }

    activity_children = {
        "Рестораны и кафе": "Еда и напитки",
        "Продуктовые магазины": "Еда и напитки",
        "Медицинские центры": "Медицина и здоровье",
        "Стоматологии": "Медицина и здоровье",
        "Автосервисы": "Авто и транспорт",
        "Шиномонтаж": "Авто и транспорт",
        "Автомойки": "Авто и транспорт",
        "Парикмахерские": "Красота и уход",
        "Салоны красоты": "Красота и уход",
        "Ногтевые студии": "Красота и уход",
        "Детские сады": "Образование",
        "Автошколы": "Образование",
        "Ремонт квартир": "Дом и ремонт",
        "Сантехника и электрика": "Дом и ремонт",
        "Веб-разработка": "IT и связь",
        "SEO и реклама": "IT и связь",
    }

    activity_grandchildren = {
        "Пиццерии": "Рестораны и кафе",
        "Суши и роллы": "Рестораны и кафе",
        "Кофейни": "Рестораны и кафе",
        "СТО грузовых авто": "Автосервисы",
        "Детейлинг авто": "Автосервисы",
        "Наращивание ресниц": "Салоны красоты",
        "Лазерная эпиляция": "Салоны красоты",
        "Массажные салоны": "Салоны красоты",
        "Курсы английского": "Образование",
        "Танцевальные студии": "Образование",
    }

    activity_id_map = {}

    # Вставляем все активности
    for name in list(activity_parents.keys()) + list(activity_children.keys()) + list(activity_grandchildren.keys()):
        res = conn.execute(
            sa.text("INSERT INTO activity (name, parent_id) VALUES (:name, NULL) RETURNING id"),
            {"name": name}
        )
        row = res.fetchone()
        if not row:
            raise ValueError(f"Не удалось создать activity: {name}")
        activity_id_map[name] = row[0]

    # Проставляем parent_id
    for child, parent in {**activity_children, **activity_grandchildren}.items():
        conn.execute(
            sa.text("UPDATE activity SET parent_id = :pid WHERE id = :cid"),
            {"pid": activity_id_map[parent], "cid": activity_id_map[child]}
        )

    # ─── 2. Здания (15) с geom вместо lat/lon ─────────────────────────────────
    buildings = [
        {"address": "ул. Ленина, 1, Москва", "lon": 37.6173, "lat": 55.7558},
        {"address": "пр. Мира, 15 к1", "lon": 37.6321, "lat": 55.7772},
        {"address": "ул. Тверская, 22 стр. 3", "lon": 37.6056, "lat": 55.7635},
        {"address": "ул. Профсоюзная, 104", "lon": 37.5064, "lat": 55.6612},
        {"address": "Кутузовский пр., 48", "lon": 37.5160, "lat": 55.7240},
        {"address": "ул. Новый Арбат, 11", "lon": 37.5881, "lat": 55.7522},
        {"address": "Ленинский пр., 45", "lon": 37.5390, "lat": 55.6925},
        {"address": "ул. Большая Дмитровка, 7/5", "lon": 37.6134, "lat": 55.7618},
        {"address": "ул. Маросейка, 10/1", "lon": 37.6347, "lat": 55.7591},
        {"address": "ул. Сретенка, 25 стр. 1", "lon": 37.6320, "lat": 55.7719},
        {"address": "ул. Мясницкая, 35", "lon": 37.6502, "lat": 55.7710},
        {"address": "Волгоградский пр., 42 к2", "lon": 37.6845, "lat": 55.7421},
        {"address": "ул. Земляной Вал, 33", "lon": 37.6531, "lat": 55.7488},
        {"address": "ул. Пречистенка, 19", "lon": 37.5940, "lat": 55.7442},
        {"address": "ул. Остоженка, 30/7", "lon": 37.6005, "lat": 55.7371},
    ]

    building_ids = []
    for b in buildings:
        # Создаём POINT(lon lat) для PostGIS
        res = conn.execute(
            sa.text("""
                INSERT INTO building (address, geom) 
                VALUES (:a, ST_SetSRID(ST_MakePoint(:lon, :lat), 4326)::geography) 
                RETURNING id
            """),
            {"a": b["address"], "lon": b["lon"], "lat": b["lat"]}
        )
        row = res.fetchone()
        if not row:
            raise ValueError(f"Не удалось создать здание: {b['address']}")
        building_ids.append(row[0])

    # ─── 3. Организации (100) ─────────────────────────────────────────────────
    organizations = [
        {"name": "ПиццаЧас 24", "b": 0, "acts": ["Пиццерии", "Рестораны и кафе"], "phones": ["+7(495)100-20-30", "+7(926)777-11-22"]},
        {"name": "Tokyo Roll", "b": 1, "acts": ["Суши и роллы", "Рестораны и кафе"], "phones": ["+7(495)333-44-55"]},
        {"name": "Гастроном №1", "b": 2, "acts": ["Продуктовые магазины"], "phones": ["+7(499)123-45-67"]},
        {"name": "МедЭксперт", "b": 3, "acts": ["Медицинские центры", "Стоматологии"], "phones": ["+7(495)777-00-11", "+7(495)777-00-12"]},
        {"name": "Грузовик Сервис", "b": 4, "acts": ["СТО грузовых авто", "Автосервисы"], "phones": ["+7(926)555-22-11"]},
        {"name": "Detail King", "b": 5, "acts": ["Детейлинг авто", "Автомойки"], "phones": ["+7(495)888-99-00"]},
        {"name": "Шины Экспресс", "b": 6, "acts": ["Шиномонтаж", "Автосервисы"], "phones": ["+7(499)222-33-44"]},
        {"name": "Lash & Brow", "b": 7, "acts": ["Наращивание ресниц", "Салоны красоты", "Лазерная эпиляция"], "phones": ["+7(495)555-66-77"]},
        {"name": "Drive School", "b": 8, "acts": ["Автошколы"], "phones": ["+7(495)999-88-77"]},
        {"name": "Солнышко 365", "b": 9, "acts": ["Детские сады"], "phones": ["+7(499)111-22-33"]},
        {"name": "Coffee & Croissant", "b": 10, "acts": ["Кофейни", "Рестораны и кафе"], "phones": ["+7(495)200-30-40"]},
        {"name": "Smile Dental", "b": 11, "acts": ["Стоматологии", "Медицинские центры"], "phones": ["+7(495)600-70-80"]},
        {"name": "Relax & SPA", "b": 12, "acts": ["Массажные салоны", "Салоны красоты"], "phones": ["+7(495)300-40-50"]},
        {"name": "English House", "b": 13, "acts": ["Курсы английского", "Образование"], "phones": ["+7(499)400-50-60"]},
        {"name": "Fix Master", "b": 14, "acts": ["Ремонт квартир", "Сантехника и электрика"], "phones": ["+7(495)900-10-20"]},
        {"name": "Pixel Craft", "b": 0, "acts": ["Веб-разработка", "SEO и реклама"], "phones": ["+7(926)111-22-33"]},
        {"name": "Family Clinic", "b": 1, "acts": ["Медицинские центры"], "phones": ["+7(495)222-33-44"]},
        {"name": "Auto Shine", "b": 2, "acts": ["Автомойки", "Детейлинг авто"], "phones": ["+7(499)333-44-55"]},
        {"name": "Beauty Queen", "b": 3, "acts": ["Парикмахерские", "Салоны красоты"], "phones": ["+7(495)444-55-66"]},
        {"name": "Little Genius", "b": 4, "acts": ["Детские сады"], "phones": ["+7(926)555-66-77"]},
        {"name": "Speed Pizza", "b": 5, "acts": ["Пиццерии"], "phones": ["+7(495)666-77-88"]},
        {"name": "Tech Support 24", "b": 6, "acts": ["Веб-разработка", "SEO и реклама"], "phones": ["+7(499)777-88-99"]},
        {"name": "Nails & Lashes", "b": 7, "acts": ["Ногтевые студии", "Наращивание ресниц"], "phones": ["+7(495)888-99-00"]},
        {"name": "Pro Drive", "b": 8, "acts": ["Автошколы", "Образование"], "phones": ["+7(926)999-00-11"]},
        {"name": "Здоровье Плюс", "b": 9, "acts": ["Медицинские центры", "Стоматологии", "Массажные салоны"], "phones": ["+7(495)111-22-33", "+7(926)222-33-44"]},
        # Еда и напитки (здания 0-4, 10-12)
        {"name": "Додо Пицца", "b": 0, "acts": ["Пиццерии"], "phones": ["+7(495)123-45-67"]},
        {"name": "Якитория", "b": 1, "acts": ["Суши и роллы"], "phones": ["+7(495)234-56-78"]},
        {"name": "Шоколадница", "b": 2, "acts": ["Кофейни"], "phones": ["+7(495)345-67-89"]},
        {"name": "Му-Му", "b": 3, "acts": ["Рестораны и кафе"], "phones": ["+7(495)456-78-90"]},
        {"name": "Кофемания", "b": 4, "acts": ["Кофейни"], "phones": ["+7(495)567-89-01"]},
        {"name": "Бургер Кинг", "b": 10, "acts": ["Рестораны и кафе"], "phones": ["+7(495)678-90-12"]},
        {"name": "Теремок", "b": 11, "acts": ["Рестораны и кафе"], "phones": ["+7(495)789-01-23"]},
        {"name": "Крошка Картошка", "b": 12, "acts": ["Рестораны и кафе"], "phones": ["+7(495)890-12-34"]},
        {"name": "Папа Джонс", "b": 0, "acts": ["Пиццерии"], "phones": ["+7(495)901-23-45"]},
        {"name": "Суши Вок", "b": 1, "acts": ["Суши и роллы"], "phones": ["+7(495)012-34-56"]},
        {"name": "Starbucks", "b": 2, "acts": ["Кофейни"], "phones": ["+7(495)123-45-68"]},
        {"name": "Макдоналдс", "b": 3, "acts": ["Рестораны и кафе"], "phones": ["+7(495)234-56-79"]},
        {"name": "KFC", "b": 4, "acts": ["Рестораны и кафе"], "phones": ["+7(495)345-67-80"]},
        {"name": "Сабвей", "b": 10, "acts": ["Рестораны и кафе"], "phones": ["+7(495)456-78-91"]},
        {"name": "Пятерочка", "b": 11, "acts": ["Продуктовые магазины"], "phones": ["+7(495)567-89-02"]},
        {"name": "Магнит", "b": 12, "acts": ["Продуктовые магазины"], "phones": ["+7(495)678-90-13"]},
        {"name": "Перекресток", "b": 0, "acts": ["Продуктовые магазины"], "phones": ["+7(495)789-01-24"]},
        {"name": "Ашан", "b": 1, "acts": ["Продуктовые магазины"], "phones": ["+7(495)890-12-35"]},
        {"name": "Лента", "b": 2, "acts": ["Продуктовые магазины"], "phones": ["+7(495)901-23-46"]},
        {"name": "Метро", "b": 3, "acts": ["Продуктовые магазины"], "phones": ["+7(495)012-34-57"]},
        # Медицина (здания 3, 5, 7, 9, 11, 13)
        {"name": "СМ-Клиника", "b": 3, "acts": ["Медицинские центры"], "phones": ["+7(495)123-45-69"]},
        {"name": "Евромед", "b": 5, "acts": ["Медицинские центры"], "phones": ["+7(495)234-56-80"]},
        {"name": "Медси", "b": 7, "acts": ["Медицинские центры"], "phones": ["+7(495)345-67-81"]},
        {"name": "Доктор рядом", "b": 9, "acts": ["Медицинские центры"], "phones": ["+7(495)456-78-92"]},
        {"name": "Стоматология 31", "b": 11, "acts": ["Стоматологии"], "phones": ["+7(495)567-89-03"]},
        {"name": "Дентал Сервис", "b": 13, "acts": ["Стоматологии"], "phones": ["+7(495)678-90-14"]},
        {"name": "МедиАрт", "b": 3, "acts": ["Медицинские центры", "Стоматологии"], "phones": ["+7(495)789-01-25"]},
        {"name": "Клиника Здоровья", "b": 5, "acts": ["Медицинские центры"], "phones": ["+7(495)890-12-36"]},
        {"name": "Добромед", "b": 7, "acts": ["Медицинские центры"], "phones": ["+7(495)901-23-47"]},
        {"name": "Стоматологическая клиника №1", "b": 9, "acts": ["Стоматологии"], "phones": ["+7(495)012-34-58"]},
        {"name": "Ортодонт Премиум", "b": 11, "acts": ["Стоматологии"], "phones": ["+7(495)123-45-70"]},
        {"name": "Детская стоматология", "b": 13, "acts": ["Стоматологии"], "phones": ["+7(495)234-56-81"]},
        {"name": "Вита Мед", "b": 3, "acts": ["Медицинские центры"], "phones": ["+7(495)345-67-82"]},
        {"name": "Гемотест", "b": 5, "acts": ["Медицинские центры"], "phones": ["+7(495)456-78-93"]},
        {"name": "Инвитро", "b": 7, "acts": ["Медицинские центры"], "phones": ["+7(495)567-89-04"]},
        # Авто (здания 4, 5, 6, 8, 12, 14)
        {"name": "АвтоВАЗ Сервис", "b": 4, "acts": ["Автосервисы"], "phones": ["+7(495)678-90-15"]},
        {"name": "Форд Техник", "b": 5, "acts": ["Автосервисы"], "phones": ["+7(495)789-01-26"]},
        {"name": "Тойота Центр", "b": 6, "acts": ["Автосервисы"], "phones": ["+7(495)890-12-37"]},
        {"name": "МосАвтоШина", "b": 8, "acts": ["Шиномонтаж"], "phones": ["+7(495)901-23-48"]},
        {"name": "АвтоДетейлинг Про", "b": 12, "acts": ["Детейлинг авто"], "phones": ["+7(495)012-34-59"]},
        {"name": "Мойка 24", "b": 14, "acts": ["Автомойки"], "phones": ["+7(495)123-45-71"]},
        {"name": "Шиномонтаж 24", "b": 4, "acts": ["Шиномонтаж"], "phones": ["+7(495)234-56-82"]},
        {"name": "Автосервис Эксперт", "b": 5, "acts": ["Автосервисы"], "phones": ["+7(495)345-67-83"]},
        {"name": "Мойка на Таганке", "b": 6, "acts": ["Автомойки"], "phones": ["+7(495)456-78-94"]},
        {"name": "Детейлинг Центр", "b": 8, "acts": ["Детейлинг авто"], "phones": ["+7(495)567-89-05"]},
        {"name": "Автошкола Главная", "b": 12, "acts": ["Автошколы"], "phones": ["+7(495)678-90-16"]},
        {"name": "Вождение Плюс", "b": 14, "acts": ["Автошколы"], "phones": ["+7(495)789-01-27"]},
        {"name": "Автомойка Люкс", "b": 4, "acts": ["Автомойки"], "phones": ["+7(495)890-12-38"]},
        {"name": "Шины и Диски", "b": 5, "acts": ["Шиномонтаж"], "phones": ["+7(495)901-23-49"]},
        {"name": "Автосервис 24/7", "b": 6, "acts": ["Автосервисы"], "phones": ["+7(495)012-34-60"]},
        # Красота (здания 3, 7, 10, 12)
        {"name": "Чистюля", "b": 3, "acts": ["Парикмахерские"], "phones": ["+7(495)123-45-72"]},
        {"name": "Парикмахерская на Тверской", "b": 7, "acts": ["Парикмахерские"], "phones": ["+7(495)234-56-83"]},
        {"name": "Ногтевая студия Люкс", "b": 10, "acts": ["Ногтевые студии"], "phones": ["+7(495)345-67-84"]},
        {"name": "Салон красоты Версаль", "b": 12, "acts": ["Салоны красоты"], "phones": ["+7(495)456-78-95"]},
        {"name": "Маникюрный рай", "b": 3, "acts": ["Ногтевые студии"], "phones": ["+7(495)567-89-06"]},
        {"name": "Студия маникюра", "b": 7, "acts": ["Ногтевые студии"], "phones": ["+7(495)678-90-17"]},
        {"name": "Красота и Здоровье", "b": 10, "acts": ["Салоны красоты", "Массажные салоны"], "phones": ["+7(495)789-01-28"]},
        {"name": "Парикмахерская 24", "b": 12, "acts": ["Парикмахерские"], "phones": ["+7(495)890-12-39"]},
        {"name": "Салон эпиляции", "b": 3, "acts": ["Лазерная эпиляция"], "phones": ["+7(495)901-23-50"]},
        {"name": "Наращивание ресниц Про", "b": 7, "acts": ["Наращивание ресниц"], "phones": ["+7(495)012-34-61"]},
        {"name": "Массажный кабинет", "b": 10, "acts": ["Массажные салоны"], "phones": ["+7(495)123-45-73"]},
        {"name": "СПА-салон Оазис", "b": 12, "acts": ["Массажные салоны", "Салоны красоты"], "phones": ["+7(495)234-56-84"]},
        {"name": "Барбершоп", "b": 3, "acts": ["Парикмахерские"], "phones": ["+7(495)345-67-85"]},
        {"name": "Косметологический кабинет", "b": 7, "acts": ["Салоны красоты"], "phones": ["+7(495)456-78-96"]},
        {"name": "Студия загара", "b": 10, "acts": ["Салоны красоты"], "phones": ["+7(495)567-89-07"]},
        # Образование (здания 8, 9, 13)
        {"name": "Детский сад Сказка", "b": 8, "acts": ["Детские сады"], "phones": ["+7(495)678-90-18"]},
        {"name": "Английская школа", "b": 9, "acts": ["Курсы английского"], "phones": ["+7(495)789-01-29"]},
        {"name": "Танцевальная студия Dance", "b": 13, "acts": ["Образование"], "phones": ["+7(495)890-12-40"]},
        {"name": "Подготовка к школе", "b": 8, "acts": ["Образование"], "phones": ["+7(495)901-23-51"]},
        {"name": "Музыкальная школа", "b": 9, "acts": ["Образование"], "phones": ["+7(495)012-34-62"]},
        {"name": "Арт-студия", "b": 13, "acts": ["Образование"], "phones": ["+7(495)123-45-74"]},
        {"name": "Языковой центр Lingua", "b": 8, "acts": ["Курсы английского"], "phones": ["+7(495)234-56-85"]},
        {"name": "Детсад Радуга", "b": 9, "acts": ["Детские сады"], "phones": ["+7(495)345-67-86"]},
        {"name": "Школа программирования", "b": 13, "acts": ["Образование"], "phones": ["+7(495)456-78-97"]},
        {"name": "Центр развития", "b": 8, "acts": ["Образование"], "phones": ["+7(495)567-89-08"]},
        # Дом и ремонт (здания 0, 5, 14)
        {"name": "Ремонт квартир Про", "b": 0, "acts": ["Ремонт квартир"], "phones": ["+7(495)678-90-19"]},
        {"name": "Сантехник 24", "b": 5, "acts": ["Сантехника и электрика"], "phones": ["+7(495)789-01-30"]},
        {"name": "Электрик на дом", "b": 14, "acts": ["Сантехника и электрика"], "phones": ["+7(495)890-12-41"]},
        {"name": "Дизайн интерьера", "b": 0, "acts": ["Ремонт квартир"], "phones": ["+7(495)901-23-52"]},
        {"name": "Отделочные работы", "b": 5, "acts": ["Ремонт квартир"], "phones": ["+7(495)012-34-63"]},
        {"name": "Сантехнические услуги", "b": 14, "acts": ["Сантехника и электрика"], "phones": ["+7(495)123-45-75"]},
        {"name": "Умный дом системс", "b": 0, "acts": ["Сантехника и электрика"], "phones": ["+7(495)234-56-86"]},
        {"name": "Ремонт под ключ", "b": 5, "acts": ["Ремонт квартир"], "phones": ["+7(495)345-67-87"]},
        {"name": "Электромонтаж", "b": 14, "acts": ["Сантехника и электрика"], "phones": ["+7(495)456-78-98"]},
        {"name": "Мастер на все руки", "b": 0, "acts": ["Ремонт квартир", "Сантехника и электрика"], "phones": ["+7(495)567-89-09"]},
        
        # IT (здания 1, 6, 11)
        {"name": "Web Studio", "b": 1, "acts": ["Веб-разработка"], "phones": ["+7(495)678-90-20"]},
        {"name": "SEO Продвижение", "b": 6, "acts": ["SEO и реклама"], "phones": ["+7(495)789-01-31"]},
        {"name": "SMM Агентство", "b": 11, "acts": ["SEO и реклама"], "phones": ["+7(495)890-12-42"]},
        {"name": "Мобильные приложения", "b": 1, "acts": ["Веб-разработка"], "phones": ["+7(495)901-23-53"]},
        {"name": "1С Разработка", "b": 6, "acts": ["Веб-разработка"], "phones": ["+7(495)012-34-64"]},
        {"name": "Ремонт компьютеров", "b": 11, "acts": ["IT и связь"], "phones": ["+7(495)123-45-76"]},
        {"name": "Настройка сетей", "b": 1, "acts": ["IT и связь"], "phones": ["+7(495)234-56-87"]},
        {"name": "Контекстная реклама", "b": 6, "acts": ["SEO и реклама"], "phones": ["+7(495)345-67-88"]},
        {"name": "IT Аутсорсинг", "b": 11, "acts": ["IT и связь"], "phones": ["+7(495)456-78-99"]},
        {"name": "Веб-студия Люкс", "b": 1, "acts": ["Веб-разработка", "SEO и реклама"], "phones": ["+7(495)567-89-10"]},
    ]

    for org in organizations:
        bid = building_ids[org["b"]]

        res = conn.execute(
            sa.text("INSERT INTO organization (name, building_id) VALUES (:n, :bid) RETURNING id"),
            {"n": org["name"], "bid": bid}
        )
        row = res.fetchone()
        if not row:
            raise ValueError(f"Не удалось создать организацию: {org['name']}")
        oid = row[0]

        # телефоны
        for ph in org["phones"]:
            conn.execute(
                sa.text("INSERT INTO phone_number (phone, organization_id) VALUES (:p, :oid)"),
                {"p": ph, "oid": oid}
            )

        # виды деятельности
        for act_name in org["acts"]:
            if act_name in activity_id_map:
                conn.execute(
                    sa.text("""
                        INSERT INTO organization_activity (organization_id, activity_id)
                        VALUES (:oid, :aid)
                        ON CONFLICT DO NOTHING
                    """),
                    {"oid": oid, "aid": activity_id_map[act_name]}
                )


def downgrade() -> None:
    logger.warning(f"=== REVERTING MIGRATION === | " f"Revision: {revision}")
    op.execute("DELETE FROM organization_activity")
    op.execute("DELETE FROM phone_number")
    op.execute("DELETE FROM organization")
    op.execute("DELETE FROM building")
    op.execute("DELETE FROM activity")
